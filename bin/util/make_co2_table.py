#!/usr/bin/env python3

""" Generate tables for CO2 fluid properties.

The tables are generated using the NIST (National Institute of Standards
and Techlology) Standard Reference Database Number 69
(https://doi.org/10.18434/T4D303).

Copyright for NIST Standard Reference Data is governed by the Standard
Reference Data Act (https://www.nist.gov/srd/public-law).

The values are calculated using the equation of Span and Wagner. Therefore,
the maximum pressure limit is the lowest of the following values:
* 800.0000 MPa
* The pressure at which a density of 1178.5 kg/m3 is reached.
"""

import urllib
import requests
import numpy as np
from io import StringIO
from string import Template


MIN_TEMP = 290  # K
MAX_TEMP = 340  # K
NUM_TEMP_SAMPLES = 50 # MIN_TEMP ist the first sample point, MAX_TEMP the last.
MIN_PRESS = 1.0e+05  # Pa
MAX_PRESS = 1.0e+08  # Pa
NUM_PRESS_SAMPLES = 495 # MIN_PRESS ist the first sample point, MAX_PRESS the last.

delta_temperature = (MAX_TEMP - MIN_TEMP) / (NUM_TEMP_SAMPLES - 1)
delta_pressure = (MAX_PRESS - MIN_PRESS) / (NUM_PRESS_SAMPLES - 1)

density_str = []
enthalpy_str = []

# get the data
for i in range(NUM_TEMP_SAMPLES):
    temperature = MIN_TEMP + i * delta_temperature
    query = {'Action': 'Data', 'Wide': 'on', 'ID': 'C124389', 'Type': 'IsoTherm',
             'Digits': '12', 'PLow': str(MIN_PRESS), 'PHigh': str(MAX_PRESS),
             'PInc': str(delta_pressure), 'T': str(temperature), 'RefState': 'DEF',
             'TUnit': 'K', 'PUnit': 'Pa', 'DUnit': 'kg/m3', 'HUnit': 'kJ/kg',
             'WUnit': 'm/s', 'VisUnit': 'uPas', 'STUnit': 'N/m'}
    response = requests.get('https://webbook.nist.gov/cgi/fluid.cgi?'
                            + urllib.parse.urlencode(query))
    response.encoding = 'utf-8'
    text = response.text
    phase = np.genfromtxt(StringIO(text), delimiter='\t', dtype=str, usecols=[-1],
                          skip_header=1)
    values = np.genfromtxt(StringIO(text), delimiter='\t', names=True)

    # NIST provides additional samples at the transition points (if there is a
    # phase transition within the requested data range). Since the code which
    # uses the tables generated by this script cant deal with this additional
    # sample points, they are removed.
    phase_boundary_indices = []
    for i in range(1, len(phase)-1):
        if phase[i] != phase[i+1]:
            phase_boundary_indices.append(i)
            phase_boundary_indices.append(i+1)
    density = np.delete(values["Density_kgm3"], phase_boundary_indices)
    enthalpy = np.delete(values["Enthalpy_kJkg"], phase_boundary_indices)
    # transform unit (kJ/kg -> J/kg)
    enthalpy *= 1000
    # format the data
    density_str.append('    {'+', '.join([format(x, '.12e') for x in density])+'}')
    enthalpy_str.append('    {'+', '.join([format(x, '.12e') for x in enthalpy])+'}')
density_str = ',\n'.join(density_str)
enthalpy_str = ',\n'.join(enthalpy_str)

# write the table by filling the gaps in the template
template = Template(open("co2values_template.inc", 'r').read())
replacements = {"MIN_TEMP": format(MIN_TEMP),
                "MAX_TEMP": format(MAX_TEMP),
                "NUM_TEMP_SAMPLES": format(NUM_TEMP_SAMPLES),
                "MIN_PRESS": format(MIN_PRESS),
                "MAX_PRESS": format(MAX_PRESS),
                "NUM_PRESS_SAMPLES": format(NUM_PRESS_SAMPLES),
                "DENSITY_VALS": density_str,
                "ENTHALPY_VALS": enthalpy_str}

with open("co2values.inc", 'w') as tables:
    tables.write(template.substitute(replacements))
